generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String           @id
  firstName      String
  lastName       String?
  email          String
  username       String?
  phoneNumber    String?
  designation    String?
  bio            String?
  socialWebsite   String?
  socialGithub    String?
  socialFacebook  String?
  socialTwitter   String?
  socialLinkedin  String?
  emailVerified  Boolean
  image          String?
  createdAt      DateTime
  updatedAt      DateTime
  sessions       Session[]
  accounts       Account[]
  courses        Course[]
  enrollment     Enrollment[]
  lessonProgress LessonProgress[]
  assignmentSubmissions AssignmentSubmission[]

  stripeCustomerId String? @unique

  role       String?
  banned     Boolean?
  banReason  String?
  banExpires DateTime?
  billingAddress BillingAddress?

  @@unique([email])
  @@unique([username])
  @@map("user")
}

model BillingAddress {
  id            String   @id @default(uuid())
  firstName     String
  lastName      String
  companyName   String?
  phoneNumber   String?
  email         String
  addressLine1  String
  addressLine2  String?
  city          String
  state         String
  postalCode    String
  country       String
  vatNumber     String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

model Course {
  id String @id @default(uuid())

  title       String
  description String
  fileKey     String
  price       Int
  duration    Int
  level       CourseLevel @default(Beginner)

  stripePriceId String @unique

  category         String
  smallDescription String
  slug             String @unique

  status CourseStatus @default(Draft)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  chapter    Chapter[]
  enrollment Enrollment[]
}

enum CourseLevel {
  Beginner
  Intermediate
  Advanced
}

enum CourseStatus {
  Draft
  Published
  Archived
}

model Chapter {
  id String @id @default(uuid())

  title    String
  position Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId  String

  lessons Lesson[]
}

model Lesson {
  id String @id @default(uuid())

  title        String
  description  String?
  thumbnailKey String?
  videoKey     String?
  position     Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Chapter   Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  chapterId String

  lessonProgress LessonProgress[]
  assignment     Assignment?
}

model Enrollment {
  id String @id @default(uuid())

  amount Int
  status EnrollmentStatus @default(Pending)

  // Ban/Punishment fields
  banned       Boolean?
  banUntil     DateTime?
  banReason    String?
  banType      BanType?

  // Follow-up and activity tracking
  followUpEmailSent Boolean @default(false)
  lastActivityAt    DateTime?

  // Student tags/labels
  tags StudentTag[]

  // Certificate management
  certificateEarned   Boolean   @default(false)
  certificateIssuedAt  DateTime?
  certificateKey       String?   @unique
  certificateRevoked   Boolean   @default(false)
  certificateRevokedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId  String
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  // Relations
  studentActivities StudentActivity[]
  studentBadges     StudentBadge[]
  loginSessions     LoginSession[]

  @@unique([userId, courseId])
}

enum BanType {
  Temporary
  Permanent
}

enum EnrollmentStatus {
  Pending
  Active
  Cancelled
}

enum StudentTag {
  TopPerformer
  NeedsHelp
  SlowLearner
  ActiveCommunicator
}

enum StudentBadgeType {
  FirstLessonCompleted
  SevenDayStreak
  HundredPercentProgress
  DiscussionContributor
  MonthlyTopPerformer
  WeeklyTopPerformer
}

enum ActivityType {
  LoggedIn
  CompletedLesson
  DownloadedFile
  MissedAssignment
  SubmittedAssignment
  ViewedLesson
  StartedCourse
}

model StudentActivity {
  id String @id @default(uuid())

  type        ActivityType
  description String?
  metadata    Json? // Store additional data like lessonId, fileKey, etc.

  createdAt DateTime @default(now())

  Enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  enrollmentId String
}

model StudentBadge {
  id String @id @default(uuid())

  badgeType StudentBadgeType
  earnedAt  DateTime @default(now())
  metadata  Json? // Store additional data like streak count, etc.

  Enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  enrollmentId String

  @@unique([enrollmentId, badgeType])
}

model LoginSession {
  id String @id @default(uuid())

  device      String?
  browser     String?
  country     String?
  ipAddress   String?
  userAgent   String?
  loggedInAt  DateTime @default(now())

  Enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  enrollmentId String
}

model LessonProgress {
  id String @id @default(uuid())

  completed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  User     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String
  Lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  lessonId String

  @@unique([userId, lessonId])
}

model Assignment {
  id String @id @default(uuid())

  title       String
  description String?
  fileKey     String?
  points      Int?      @default(100)
  dueDate     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  lessonId String @unique

  submissions AssignmentSubmission[]
}

model AssignmentSubmission {
  id String @id @default(uuid())

  fileKey        String?
  link           String?
  description    String?
  submissionCount Int      @default(1)
  status         AssignmentSubmissionStatus @default(Pending)
  grade          Int?
  feedback       String?
  submittedAt    DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  Assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  assignmentId String

  User   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([userId, assignmentId])
}

enum AssignmentSubmissionStatus {
  Pending
  Graded
  Returned
}
